# RV32_asm

## 初めに
これは C++ で書かれた RISC-V の JIT アセンブラの PoC 実装です。
RV32GC の割り込みや SCR 周りを除くほとんどの命令をサポートします。
レジスタ名については、 zero 、 sp 、 ft0 などの別名も使用できます。
また、圧縮命令を有効にすると、圧縮可能な場合は自動的に圧縮命令を生成します。

生成した命令の実行は生成した命令に対応した環境でしか動作しませんが、
それ以外は C++14 準拠の環境であれば動作するはずです。

本ライブラリのアイディアの元ネタは Xbyak(https://github.com/herumi/xbyak)です。
一部の実装手法や変数名などは参考にしましたが、このライブラリは0から書き起こしています。

## 使用方法
基本的に、 リポジトリ内の全ての hpp ファイルに適宜パスを通して
RV32_asm.hpp をインクルードするだけでOKです。

具体的な使用方法は RV32_asm_test.cpp を参考にしてください。

## アセンブラ命令の記述方法
基本的に RV32 対応の GNU assembler の文法を元にしています。

### 基本的な命令
通常の命令は、例えば、
>    addi a0, a0, 42

は

>   addi(a0, a0, 42);

のように単にカッコとセミコロンを追加して記述します。

また、C++の文法上の制約のためオフセット値を指定する

> lw a0,16(sp)

は

> lw(a0,sp[16]);

または

> lw(a0,sp(16));

のようにカッコの内外を入れ替えた形で記述します。
その際、カッコには丸カッコと角カッコのどちらでも使用可能です。
また、

> lw a0,(sp)

のように、オフセットを省略する場合は

> lw(a0,sp());

のように記述します。（角カッコは不可です）

### ラベル
ラベルは 
> L("ラベル文字列");

という形式で定義し、

 > bne(a5, a2, "ラベル文字列");

のように文字列を直接指定して使います。
定義と使用は前後しても問題なく動作します。
ラベル文字列は単なるアドレスに紐づく識別子としてしか機能しません。
一般的なアセンブラで実装されているような高度な機能は一切ありません。

### 圧縮命令
本ライブラリでは圧縮命令を直接記述する手段は用意していません。
その代わりに、通常通りに命令を記述すると、圧縮命令で表現可能な引数かどうか判定し、可能であれば自動的に圧縮命令を生成します。
この機能は圧縮命令の使用を有効にした場合のみ適用されます。

## サンプルコード
sample/ に使用例のサンプルコードがあります。
Makefile は RISC-V 対応の gcc と、エミュレータの spike が
使用できる環境を想定しているので、それらが異なる環境では何とかしてください。

## 参考資料
* herumi/xbyak(https://github.com/herumi/xbyak)
* Xbyakの紹介とその周辺(https://www.slideshare.net/herumi/xbyak)
* RISC-V Instruction Set Specification(https://msyksphinz-self.github.io/riscv-isadoc/html/index.html)
* The RISC-V Instruction Set Manual Volume I: Unprivileged ISA Document Version 20191213(https://riscv.org/wp-content/uploads/2019/12/riscv-spec-20191213.pdf)
